From a0cad113d1c23108b644ec9938687e1b6a31a6de Mon Sep 17 00:00:00 2001
From: John Andersen <john.s.andersen@intel.com>
Date: Wed, 8 Jan 2020 13:14:30 -0800
Subject: [PATCH 1/3] X86: Update mmu_cr4_features when when pinning

Signed-off-by: John Andersen <john.s.andersen@intel.com>
---
 arch/x86/kernel/cpu/common.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.c
index fffe21945374..5525541695f9 100644
--- a/arch/x86/kernel/cpu/common.c
+++ b/arch/x86/kernel/cpu/common.c
@@ -423,6 +423,8 @@ void cr4_init(void)
 	this_cpu_write(cpu_tlbstate.cr4, cr4);
 }
 
+extern unsigned long mmu_cr4_features;
+
 /*
  * Once CPU feature detection is finished (and boot params have been
  * parsed), record any of the sensitive CR bits that are set, and
@@ -432,8 +434,10 @@ static void __init setup_cr_pinning(void)
 {
 	unsigned long mask;
 
+	mmu_cr4_features = this_cpu_read(cpu_tlbstate.cr4);
+
 	mask = (X86_CR4_SMEP | X86_CR4_SMAP | X86_CR4_UMIP);
-	cr4_pinned_bits = this_cpu_read(cpu_tlbstate.cr4) & mask;
+	cr4_pinned_bits = mmu_cr4_features & mask;
 	static_key_enable(&cr_pinning.key);
 }
 
-- 
2.21.0

